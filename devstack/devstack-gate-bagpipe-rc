# This file is hooked from https://github.com/openstack-infra/project-config/blob/master/jenkins/jobs/networking-bgpvpn.yaml

export OVERRIDE_ENABLED_SERVICES=n-api,n-crt,n-cpu,n-cond,n-api-meta,n-sch,placement-api,g-api,g-reg,neutron-api,neutron-agent,neutron-dhcp,neutron-l3,neutron-metadata-agent,neutron-bagpipe-bgp,key,mysql,rabbit

if [[ $DEVSTACK_GATE_TEMPEST -eq 1 ]] ; then
    export DEVSTACK_GATE_TEMPEST_ALL_PLUGINS=1

    # temporary blacklist some tests until bug #1789878 is solved
    r="^(?!.*("
    r="$r(?:TestBGPVPNBasic\.test_bgpvpn_negative_delete_router_association)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_port_association_bgpvpn_route)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_port_association_create_and_delete)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_port_association_create_and_update)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_port_association_local_pref)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_update_rt_and_keep_local_connectivity_variant1)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_update_rt_and_keep_local_connectivity_variant2)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_variant2)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_variant4)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_variant5)"
    r="$r|(?:TestBGPVPNBasic\.test_bgpvpn_variant6)"
    r="$r))"

    export DEVSTACK_GATE_TEMPEST_REGEX="$r(networking_bgpvpn_tempest\.)"
    export OVERRIDE_ENABLED_SERVICES=${OVERRIDE_ENABLED_SERVICES},tempest
fi

export DEVSTACK_LOCAL_CONFIG+=$'\n'"NETWORKING_BGPVPN_DRIVER=BGPVPN:BaGPipe:networking_bgpvpn.neutron.services.service_drivers.bagpipe.bagpipe_v2.BaGPipeBGPVPNDriver:default"
export DEVSTACK_LOCAL_CONFIG+=$'\n'"enable_plugin networking-bagpipe https://git.openstack.org/openstack/networking-bagpipe"
export DEVSTACK_LOCAL_CONFIG+=$'\n'"BAGPIPE_DATAPLANE_DRIVER_IPVPN=ovs"

# until we do multinode, there is no BGP peer to connect to
export DEVSTACK_LOCAL_CONFIG+=$'\n'"BAGPIPE_BGP_PEERS=-"

# https://bugs.launchpad.net/devstack/+bug/1567052
# so we need VERBOSE=False until bagpipe-bgp uses rootwrap and is not run with sudo (same for bagpipe-fakerr)
export DEVSTACK_LOCAL_CONFIG+=$'\n'"VERBOSE=False"

# at least some DB setup things (e.g. for functional tests) require
# helpers from neutron devstack plugin
export DEVSTACK_LOCAL_CONFIG+=$'\n'"enable_plugin neutron git://git.openstack.org/openstack/neutron"

# Using the openvswitch firewall driver for security groups is currently
# required to allow BGPVPN/router coexistence in single node or DVR setup
export DEVSTACK_LOCAL_CONFIG+=$'\n'"[[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]"
export DEVSTACK_LOCAL_CONFIG+=$'\n'"[securitygroup]"
export DEVSTACK_LOCAL_CONFIG+=$'\n'"firewall_driver = openvswitch"

